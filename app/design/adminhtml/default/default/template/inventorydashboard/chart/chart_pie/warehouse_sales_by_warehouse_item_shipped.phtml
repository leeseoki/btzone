<?php
    $series = array();
    $id = $this->getIdBox();
    $requestData = Mage::helper('adminhtml')->prepareFilterString($this->getRequest()->getParam('top_filter'));
    $reportCode = $this->getReportCode();
    if(empty($requestData)){
        $requestData = array();
        $resource = Mage::getSingleton('core/resource');
        $readConnection = $resource->getConnection('core_read');
        $installer = Mage::getModel('core/resource');
        $sql = 'SELECT default_time_range
        FROM '.$installer->getTableName("erp_inventory_dashboard_report_type").'
        WHERE report_code = "'.$reportCode.'"';
        $results = $readConnection->fetchAll($sql);
        $requestData['report_radio_select'] = $reportCode;
        foreach($results as $time){$requestData['select_time'] = $time['default_time_range'];}
        $requestData['warehouse_select'] = "0";
    }
    $name = 'All Warehouses';
    if($requestData['warehouse_select'] > 0){
        $name = Mage::helper('inventoryreports')->getWarehouseName($requestData['warehouse_select']);
    }
    $gettime = Mage::Helper('inventoryreports')->getTimeSelected($requestData);
    $warehouse_name = array();
    $item_shipped = array();
    $resource = Mage::getSingleton('core/resource');
    $readConnection = $resource->getConnection('core_read');
    $installer = Mage::getModel('core/resource');
    if(isset($requestData['warehouse_select']) && $requestData['warehouse_select'] > 0){
        $is_warehouse = 1;
        $warehouse_collection = Mage::getModel('inventoryplus/warehouse')->load($requestData['warehouse_select']);
        $sql = 'SELECT w.warehouse_name, w.product_id, sum(w.qty_shipped) AS item_shipped, f.created_at
            FROM '.$installer->getTableName("erp_inventory_warehouse_shipment w").'
            INNER JOIN '.$installer->getTableName("sales_flat_shipment f").'
            ON w.order_id = f.order_id
            WHERE w.warehouse_id > 0 AND w.warehouse_name = "'.$warehouse_collection->getWarehouseName().'" AND f.created_at BETWEEN "'.$gettime['date_from'].'" AND "'.$gettime['date_to'].'"
            GROUP BY w.product_id
            ORDER BY item_shipped DESC 
            ';
    }
    else{
        $is_warehouse = 0;
        $sql = 'SELECT w.warehouse_name, SUM(w.qty_shipped) AS item_shipped, f.created_at
            FROM '.$installer->getTableName("erp_inventory_warehouse_shipment w").'
            INNER JOIN '.$installer->getTableName("sales_flat_shipment f").'
            ON w.order_id = f.order_id
            WHERE w.warehouse_id > 0 AND f.created_at BETWEEN "'.$gettime['date_from'].'" AND "'.$gettime['date_to'].'"
            GROUP BY w.warehouse_name
            ORDER BY item_shipped DESC ';
    }
    $results = $readConnection->fetchAll($sql);
    if(isset($requestData['warehouse_select']) && $requestData['warehouse_select'] > 0){
        $checkResult = 0;
        foreach($results as $result){
            if($checkResult > 10){
                $limit = 10;
                break;
            }
            if($result['item_shipped'] == NULL || $result['item_shipped'] <= 0){
                $limit = $checkResult;
                continue;
            }
            $checkResult++;
        } 
        if(isset($limit)){
            $sql .= 'LIMIT '.$limit.'';
            $results = $readConnection->fetchAll($sql);
        }
    }
    if($is_warehouse == 0){
        foreach ($results as $result) {
            $warehouse_name[]   =   $result['warehouse_name'];
            $item_shipped[]     =   $result['item_shipped'];
        }
    }
    else{
        foreach ($results as $result) {
            $warehouse_name[]   =   Mage::getModel('catalog/product')->load($result['product_id'])->getName();
            $item_shipped[]     =   $result['item_shipped'];
        }
    }
    $i = 0;
    $categories = '[';
    foreach ($warehouse_name as $name_value) {
            if ($i != 0) {
                $categories .= ',';
            }
            $categories .= '"' . $name_value . '"';
            $i++;
        }
    $categories .= ']';    
//            Zend_debug::dump($categories);
    $j=0;
    $series['inventory_warehouse']['name'] = $this->__('Item Shipped by Warehouse');
    $series['inventory_warehouse']['data'] = '[';    
    foreach($item_shipped as $number_value){
            if ($j != 0) {
                $series['inventory_warehouse']['data'] .= ',';
            }
            $series['inventory_warehouse']['data'] .= $number_value;
            $j++;
    }
    $series['inventory_warehouse']['data'] .= ']';
//            Zend_debug::dump($series);    
?>
<?php
    $series = '';
    $i = 0;
    if($is_warehouse == 0){
        foreach ($results as $result) {
        if ($i != 0)
            $series .= ',';
        $series .= '[\'' . $result['warehouse_name'] . '(' . $result['item_shipped'] . ' items shipped)\',' . $result['item_shipped'] . ']';
        $i++;
        } 
    }
    else{
        foreach ($results as $result) {
        if ($i != 0)
            $series .= ',';
        $series .= '[\'' . Mage::getModel('catalog/product')->load($result['product_id'])->getName() . '(' . $result['item_shipped'] . ' items shipped)\',' . $result['item_shipped'] . ']';
        $i++;
        } 
    }
?>
            <!-- report by warehouse pie -->
<div class="chart-parent-div">
    <script type="text/javascript">
                $(function () {
                $_('#<?php echo $id?>').highcharts({
                chart: {
                    type: 'pie',
                    options3d: {
                        enabled: true,
                        alpha: 50
                    }
                },
                title: {
                    text: '<?php echo $this->__('Item Shipped by Warehouse: "'.$name.'"') ?>',
                },
                plotOptions: {
                    pie: {
                        depth: 30
                    }
                },
                series: [{
                    data: [
                        <?php echo $series;?>
                    ]
                }]
                });
                });
    </script>
    <div id="<?php echo $id?>" class="chart-child-div" ></div>
</div>